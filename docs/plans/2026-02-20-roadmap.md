# DBS Store — Plan de développement (Phase 2+)

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Transformer le catalogue produits fonctionnel en un e-commerce complet avec panier, checkout, espace compte et back-office admin.

**Architecture:** Cart côté client (Zustand + localStorage), commandes en base SQLite (nouvelles tables `orders`/`order_items`), paiement par défaut à la livraison (COD), admin protégé par le middleware existant + appartenance org `dbs-store`.

**Tech Stack:** Next.js 16 App Router, Zustand, Drizzle ORM (SQLite), Better Auth (déjà en place), Resend, Vitest + RTL.

---

## Validation & Suivi

Chaque phase se valide avec :
1. `bun run test` — tous les tests passent
2. `bun run build` — build sans erreur
3. `bun run lint` — pas d'erreurs ESLint
4. Test manuel sur `http://localhost:33000`

Workflow Git : une branche `feat/<nom>` par phase, squash merge vers `main`.

---

## Phase 1 — Données de démo

> **Branche :** `feat/seed-data`
> **Durée estimée :** 0.5 jour
> **Objectif :** Remplir la DB avec des produits réalistes pour que toutes les pages s'affichent avec du contenu.

### Task 1.1 : Image placeholder

**Files:**
- Create: `public/images/products/placeholder.svg`

**Step 1 : Créer le placeholder SVG**

```svg
<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400">
  <rect width="400" height="400" fill="#f1f5f9"/>
  <rect x="150" y="120" width="100" height="160" rx="8" fill="#cbd5e1"/>
  <circle cx="200" cy="100" r="20" fill="#94a3b8"/>
</svg>
```

**Step 2 : Vérifier que la page produit s'affiche sans erreur 404 d'image**

**Step 3 : Commit**
```bash
git add public/images/products/placeholder.svg
git commit -m "assets: add product image placeholder"
```

---

### Task 1.2 : Script de seed produits

**Files:**
- Modify: `scripts/seed.ts`
- Reference: `lib/db/schema.ts` — colonnes : id, name, slug, category_id, subcategory_id, price, old_price, brand, images (JSON), description, specs (JSON), stock, badge, is_active, created_at

**Step 1 : Vérifier le script existant**
```bash
cat scripts/seed.ts
```

**Step 2 : Écrire le script de seed avec 20 produits répartis sur les catégories principales**

Le fichier doit insérer des produits couvrant : smartphones (iphone, samsung-galaxy), tablettes (ipad), ordinateurs (laptops), audio (ecouteurs-sans-fil, casques), accessoires (chargeurs-cables). Minimum 3 produits par catégorie principale. Quelques produits avec `old_price` (promos) et `badge` ("Nouveau", "Populaire", "Promo").

```ts
// scripts/seed.ts
import Database from "better-sqlite3";
import { drizzle } from "drizzle-orm/better-sqlite3";
import { products } from "@/lib/db/schema";

const db = drizzle(new Database(process.env.DATABASE_URL ?? "./dev.db"));

const PRODUCTS = [
  {
    id: "iphone-16-pro-max",
    name: "iPhone 16 Pro Max 256 Go",
    slug: "iphone-16-pro-max-256go",
    category_id: "smartphones",
    subcategory_id: "iphone",
    price: 1_050_000,
    old_price: null,
    brand: "Apple",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "iPhone 16 Pro Max avec puce A18 Pro, écran 6,9 pouces Super Retina XDR et système photo avancé.",
    specs: JSON.stringify({ Écran: "6,9\" Super Retina XDR", Puce: "A18 Pro", Stockage: "256 Go", RAM: "8 Go", Batterie: "4 685 mAh", OS: "iOS 18" }),
    stock: 5,
    badge: "Nouveau",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "iphone-15-128",
    name: "iPhone 15 128 Go",
    slug: "iphone-15-128go",
    category_id: "smartphones",
    subcategory_id: "iphone",
    price: 650_000,
    old_price: 720_000,
    brand: "Apple",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "iPhone 15 avec Dynamic Island, puce A16 Bionic et port USB-C.",
    specs: JSON.stringify({ Écran: "6,1\" Super Retina XDR", Puce: "A16 Bionic", Stockage: "128 Go", RAM: "6 Go", Batterie: "3 877 mAh", OS: "iOS 18" }),
    stock: 8,
    badge: "Promo",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "samsung-s25-ultra",
    name: "Samsung Galaxy S25 Ultra 256 Go",
    slug: "samsung-s25-ultra-256go",
    category_id: "smartphones",
    subcategory_id: "samsung-galaxy",
    price: 980_000,
    old_price: null,
    brand: "Samsung",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "Galaxy S25 Ultra avec S Pen intégré, Snapdragon 8 Elite et zoom optique 5×.",
    specs: JSON.stringify({ Écran: "6,9\" Dynamic AMOLED 2X", Processeur: "Snapdragon 8 Elite", Stockage: "256 Go", RAM: "12 Go", Batterie: "5 000 mAh", OS: "Android 15" }),
    stock: 3,
    badge: "Nouveau",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "samsung-s24-fe",
    name: "Samsung Galaxy S24 FE 128 Go",
    slug: "samsung-s24-fe-128go",
    category_id: "smartphones",
    subcategory_id: "samsung-galaxy",
    price: 420_000,
    old_price: 480_000,
    brand: "Samsung",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "Galaxy S24 FE avec Exynos 2500, écran AMOLED 120 Hz et Galaxy AI.",
    specs: JSON.stringify({ Écran: "6,7\" AMOLED 120 Hz", Processeur: "Exynos 2500", Stockage: "128 Go", RAM: "8 Go", Batterie: "4 700 mAh", OS: "Android 15" }),
    stock: 12,
    badge: "Promo",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "ipad-air-m2",
    name: "iPad Air M2 11 pouces 128 Go Wi-Fi",
    slug: "ipad-air-m2-11-128go",
    category_id: "tablettes",
    subcategory_id: "ipad",
    price: 720_000,
    old_price: null,
    brand: "Apple",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "iPad Air avec puce M2, écran Liquid Retina 11 pouces et compatibilité Apple Pencil Pro.",
    specs: JSON.stringify({ Écran: "11\" Liquid Retina", Puce: "M2", Stockage: "128 Go", RAM: "8 Go", Batterie: "28,65 Wh", OS: "iPadOS 18" }),
    stock: 6,
    badge: "Populaire",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "ipad-10-gen",
    name: "iPad 10e génération 64 Go Wi-Fi",
    slug: "ipad-10e-gen-64go",
    category_id: "tablettes",
    subcategory_id: "ipad",
    price: 430_000,
    old_price: 490_000,
    brand: "Apple",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "iPad standard avec puce A14 Bionic, écran 10,9 pouces et port USB-C.",
    specs: JSON.stringify({ Écran: "10,9\" Liquid Retina", Puce: "A14 Bionic", Stockage: "64 Go", RAM: "4 Go", OS: "iPadOS 18" }),
    stock: 10,
    badge: "Promo",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "macbook-air-m3",
    name: "MacBook Air M3 13 pouces 16 Go / 512 Go",
    slug: "macbook-air-m3-16-512",
    category_id: "ordinateurs",
    subcategory_id: "laptops",
    price: 1_350_000,
    old_price: null,
    brand: "Apple",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "MacBook Air M3 ultra-fin et silencieux avec autonomie de 18 heures.",
    specs: JSON.stringify({ Processeur: "Apple M3", RAM: "16 Go", Stockage: "512 Go SSD", Écran: "13,6\" Liquid Retina", Autonomie: "18 h", Ports: "2× USB-C Thunderbolt" }),
    stock: 4,
    badge: "Populaire",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "hp-victus-15",
    name: "HP Victus 15 Gaming i5 / RTX 4060 / 16 Go",
    slug: "hp-victus-15-i5-rtx4060",
    category_id: "ordinateurs",
    subcategory_id: "laptops",
    price: 780_000,
    old_price: 850_000,
    brand: "HP",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "Laptop gaming HP Victus 15 avec écran 144 Hz et GPU RTX 4060.",
    specs: JSON.stringify({ Processeur: "Intel Core i5-13500H", GPU: "RTX 4060 8 Go", RAM: "16 Go DDR5", Stockage: "512 Go NVMe", Écran: "15,6\" FHD 144 Hz" }),
    stock: 2,
    badge: "Promo",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "airpods-pro-2",
    name: "AirPods Pro 2e génération",
    slug: "airpods-pro-2",
    category_id: "audio",
    subcategory_id: "ecouteurs-sans-fil",
    price: 220_000,
    old_price: null,
    brand: "Apple",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "AirPods Pro avec réduction de bruit active H2, audio spatial personnalisé et boîtier MagSafe USB-C.",
    specs: JSON.stringify({ Puce: "H2", ANC: "Oui", "Audio spatial": "Oui", Autonomie: "6 h (30 h avec boîtier)", Résistance: "IPX4", Connectivité: "Bluetooth 5.3" }),
    stock: 15,
    badge: "Populaire",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "samsung-buds3-pro",
    name: "Samsung Galaxy Buds3 Pro",
    slug: "samsung-buds3-pro",
    category_id: "audio",
    subcategory_id: "ecouteurs-sans-fil",
    price: 180_000,
    old_price: 210_000,
    brand: "Samsung",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "Écouteurs premium Samsung avec ANC, audio Hi-Fi 24 bits et design iconique à lame.",
    specs: JSON.stringify({ ANC: "Oui", "Hi-Fi": "24 bits / 96 kHz", Autonomie: "6 h (30 h boîtier)", Résistance: "IP57", Connectivité: "Bluetooth 5.4" }),
    stock: 7,
    badge: "Promo",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "sony-wh1000xm5",
    name: "Sony WH-1000XM5 Casque sans fil",
    slug: "sony-wh1000xm5",
    category_id: "audio",
    subcategory_id: "casques",
    price: 290_000,
    old_price: 340_000,
    brand: "Sony",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "Casque audiophile Sony avec la meilleure ANC du marché, 30 h d'autonomie et son Hi-Res.",
    specs: JSON.stringify({ ANC: "Oui (8 micros)", Autonomie: "30 h", "Charge rapide": "3 min = 3 h", Codec: "LDAC, AAC, SBC", Poids: "250 g" }),
    stock: 5,
    badge: "Promo",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "cable-usb-c-60w",
    name: "Câble USB-C vers USB-C 60 W 2 m",
    slug: "cable-usb-c-60w-2m",
    category_id: "accessoires",
    subcategory_id: "chargeurs-cables",
    price: 8_500,
    old_price: null,
    brand: "Anker",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "Câble USB-C renforcé Anker 60 W compatible iPhone 15, Android et MacBook.",
    specs: JSON.stringify({ Puissance: "60 W", Longueur: "2 m", Compatibilité: "USB-C universel", Certification: "MFi" }),
    stock: 50,
    badge: null,
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "chargeur-45w-samsung",
    name: "Chargeur Samsung 45 W Super Fast",
    slug: "chargeur-samsung-45w",
    category_id: "accessoires",
    subcategory_id: "chargeurs-cables",
    price: 25_000,
    old_price: 32_000,
    brand: "Samsung",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "Chargeur mural Samsung 45 W Super Fast Charging 2.0, compatible Galaxy S et Note.",
    specs: JSON.stringify({ Puissance: "45 W", Ports: "1× USB-C", Protocole: "PD 3.0 / Samsung SFC 2.0", Poids: "80 g" }),
    stock: 20,
    badge: "Promo",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "coque-iphone-16-pro",
    name: "Coque MagSafe iPhone 16 Pro — Silicone Minuit",
    slug: "coque-magsafe-iphone16pro-minuit",
    category_id: "accessoires",
    subcategory_id: "coques-protections",
    price: 45_000,
    old_price: null,
    brand: "Apple",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "Coque officielle Apple en silicone doux avec MagSafe, compatible iPhone 16 Pro.",
    specs: JSON.stringify({ Compatibilité: "iPhone 16 Pro", MagSafe: "Oui", Matière: "Silicone", Couleur: "Minuit" }),
    stock: 18,
    badge: null,
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "apple-watch-s10",
    name: "Apple Watch Series 10 46 mm GPS",
    slug: "apple-watch-series-10-46mm",
    category_id: "montres",
    subcategory_id: "apple-watch",
    price: 520_000,
    old_price: null,
    brand: "Apple",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "Apple Watch Series 10 la plus fine, avec écran OLED et capteur de santé avancé.",
    specs: JSON.stringify({ Taille: "46 mm", Écran: "OLED Always-On", GPS: "Oui", Résistance: "50 m", Autonomie: "18 h", Puce: "S10 SiP" }),
    stock: 4,
    badge: "Nouveau",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "samsung-watch7",
    name: "Samsung Galaxy Watch 7 44 mm",
    slug: "samsung-galaxy-watch7-44mm",
    category_id: "montres",
    subcategory_id: "samsung-galaxy-watch",
    price: 310_000,
    old_price: 360_000,
    brand: "Samsung",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "Galaxy Watch 7 avec capteur BioActive avancé, Exynos W1000 et Wear OS 5.",
    specs: JSON.stringify({ Taille: "44 mm", Processeur: "Exynos W1000", Résistance: "5 ATM + IP68", Autonomie: "40 h (Normal)", GPS: "Oui", OS: "Wear OS 5" }),
    stock: 6,
    badge: "Promo",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "google-pixel9",
    name: "Google Pixel 9 128 Go",
    slug: "google-pixel9-128go",
    category_id: "smartphones",
    subcategory_id: "google-pixel",
    price: 680_000,
    old_price: null,
    brand: "Google",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "Pixel 9 avec Tensor G4, intelligence artificielle Gemini et écran Actua OLED.",
    specs: JSON.stringify({ Processeur: "Google Tensor G4", RAM: "12 Go", Stockage: "128 Go", Écran: "6,3\" Actua OLED 120 Hz", Batterie: "4 700 mAh", OS: "Android 15" }),
    stock: 3,
    badge: "Nouveau",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "xiaomi-15-pro",
    name: "Xiaomi 15 Pro 256 Go",
    slug: "xiaomi-15-pro-256go",
    category_id: "smartphones",
    subcategory_id: "xiaomi",
    price: 590_000,
    old_price: null,
    brand: "Xiaomi",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "Xiaomi 15 Pro avec Snapdragon 8 Elite, optique Leica et charge 90 W.",
    specs: JSON.stringify({ Processeur: "Snapdragon 8 Elite", RAM: "12 Go", Stockage: "256 Go", Écran: "6,73\" AMOLED 120 Hz", Batterie: "6 100 mAh", Charge: "90 W" }),
    stock: 5,
    badge: null,
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "jbl-flip7",
    name: "JBL Flip 7 Enceinte Bluetooth",
    slug: "jbl-flip7",
    category_id: "audio",
    subcategory_id: "enceintes-bluetooth",
    price: 95_000,
    old_price: 115_000,
    brand: "JBL",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "JBL Flip 7 portable, IP67, 12 h d'autonomie et son puissant 360°.",
    specs: JSON.stringify({ Puissance: "20 W", Autonomie: "12 h", Résistance: "IP67", Bluetooth: "5.4", Poids: "600 g" }),
    stock: 9,
    badge: "Promo",
    is_active: true,
    created_at: new Date(),
  },
  {
    id: "samsung-tab-s9-fe",
    name: "Samsung Galaxy Tab S9 FE 128 Go Wi-Fi",
    slug: "samsung-tab-s9-fe-128go",
    category_id: "tablettes",
    subcategory_id: "samsung-tab",
    price: 360_000,
    old_price: 420_000,
    brand: "Samsung",
    images: JSON.stringify(["/images/products/placeholder.svg"]),
    description: "Tab S9 FE avec Exynos 1380, écran 10,9 pouces et stylet S Pen inclus.",
    specs: JSON.stringify({ Processeur: "Exynos 1380", RAM: "6 Go", Stockage: "128 Go", Écran: "10,9\" TFT LCD 90 Hz", Batterie: "8 000 mAh", S_Pen: "Inclus" }),
    stock: 7,
    badge: "Promo",
    is_active: true,
    created_at: new Date(),
  },
];

async function main() {
  console.log("Seeding products...");
  await db.delete(products);
  // @ts-expect-error created_at is Date not number
  await db.insert(products).values(PRODUCTS);
  console.log(`Inserted ${PRODUCTS.length} products.`);
}

main().catch(console.error);
```

**Step 3 : Exécuter le seed**
```bash
bun run db:seed
```
Attendu : `Inserted 20 products.`

**Step 4 : Vérifier sur la page d'accueil**
Ouvrir `http://localhost:33000` — les sections "Produits populaires" et "Promotions en cours" doivent afficher des cartes produits.

**Step 5 : Commit**
```bash
git add scripts/seed.ts public/images/products/placeholder.svg
git commit -m "feat: seed 20 demo products across all categories"
```

---

## Phase 2 — Panier (Cart)

> **Branche :** `feat/cart`
> **Durée estimée :** 1 jour
> **Objectif :** Ajouter/retirer des produits dans un panier persistant (localStorage), avec un drawer latéral et un compteur dans l'AppBar.

### Task 2.1 : Store Zustand

**Files:**
- Create: `lib/cart.ts`
- Install: `bun add zustand`

**Step 1 : Écrire le test**
```ts
// tests/lib/cart.test.ts
import { describe, it, expect, beforeEach } from "vitest";
import { useCartStore } from "@/lib/cart";
import { act } from "@testing-library/react";

// Reset store between tests
beforeEach(() => {
  act(() => useCartStore.setState({ items: [] }));
});

describe("useCartStore", () => {
  const item = {
    productId: "p1",
    slug: "iphone-16",
    name: "iPhone 16",
    price: 1_000_000,
    image: "/placeholder.svg",
  };

  it("adds item to empty cart", () => {
    act(() => useCartStore.getState().addItem(item));
    const { items } = useCartStore.getState();
    expect(items).toHaveLength(1);
    expect(items[0].quantity).toBe(1);
  });

  it("increments quantity on duplicate add", () => {
    act(() => {
      useCartStore.getState().addItem(item);
      useCartStore.getState().addItem(item);
    });
    expect(useCartStore.getState().items[0].quantity).toBe(2);
  });

  it("removes item", () => {
    act(() => {
      useCartStore.getState().addItem(item);
      useCartStore.getState().removeItem("p1");
    });
    expect(useCartStore.getState().items).toHaveLength(0);
  });

  it("updates quantity", () => {
    act(() => {
      useCartStore.getState().addItem(item);
      useCartStore.getState().setQuantity("p1", 5);
    });
    expect(useCartStore.getState().items[0].quantity).toBe(5);
  });

  it("removes item when quantity set to 0", () => {
    act(() => {
      useCartStore.getState().addItem(item);
      useCartStore.getState().setQuantity("p1", 0);
    });
    expect(useCartStore.getState().items).toHaveLength(0);
  });

  it("computes total", () => {
    act(() => {
      useCartStore.getState().addItem(item);
      useCartStore.getState().addItem({ ...item, productId: "p2", price: 500_000 });
    });
    expect(useCartStore.getState().total()).toBe(1_500_000);
  });

  it("computes count", () => {
    act(() => {
      useCartStore.getState().addItem(item);
      useCartStore.getState().setQuantity("p1", 3);
    });
    expect(useCartStore.getState().count()).toBe(3);
  });
});
```

**Step 2 : Vérifier que le test échoue**
```bash
bun run test tests/lib/cart.test.ts
```
Attendu : FAIL "Cannot find module @/lib/cart"

**Step 3 : Implémenter le store**

```ts
// lib/cart.ts
import { create } from "zustand";
import { persist } from "zustand/middleware";

export type CartItem = {
  productId: string;
  slug: string;
  name: string;
  price: number;
  image: string;
  quantity: number;
};

type CartState = {
  items: CartItem[];
  addItem: (item: Omit<CartItem, "quantity">) => void;
  removeItem: (productId: string) => void;
  setQuantity: (productId: string, quantity: number) => void;
  clear: () => void;
  total: () => number;
  count: () => number;
};

export const useCartStore = create<CartState>()(
  persist(
    (set, get) => ({
      items: [],
      addItem(item) {
        set((state) => {
          const existing = state.items.find((i) => i.productId === item.productId);
          if (existing) {
            return {
              items: state.items.map((i) =>
                i.productId === item.productId ? { ...i, quantity: i.quantity + 1 } : i
              ),
            };
          }
          return { items: [...state.items, { ...item, quantity: 1 }] };
        });
      },
      removeItem(productId) {
        set((state) => ({ items: state.items.filter((i) => i.productId !== productId) }));
      },
      setQuantity(productId, quantity) {
        if (quantity <= 0) {
          get().removeItem(productId);
          return;
        }
        set((state) => ({
          items: state.items.map((i) =>
            i.productId === productId ? { ...i, quantity } : i
          ),
        }));
      },
      clear() {
        set({ items: [] });
      },
      total() {
        return get().items.reduce((sum, i) => sum + i.price * i.quantity, 0);
      },
      count() {
        return get().items.reduce((sum, i) => sum + i.quantity, 0);
      },
    }),
    { name: "dbs-cart" }
  )
);
```

**Step 4 : Vérifier que les tests passent**
```bash
bun run test tests/lib/cart.test.ts
```
Attendu : PASS (7 tests)

**Step 5 : Commit**
```bash
git add lib/cart.ts tests/lib/cart.test.ts
git commit -m "feat: add Zustand cart store with persistence"
```

---

### Task 2.2 : CartDrawer component

**Files:**
- Create: `components/cart/cart-drawer.tsx`
- Create: `components/cart/cart-item-row.tsx`
- Modify: `components/ui/` — vérifier que Sheet est disponible (déjà installé)

**Step 1 : Écrire le test**
```tsx
// tests/components/cart/cart-drawer.test.tsx
import { describe, it, expect, vi, beforeEach } from "vitest";
import { render, screen, fireEvent } from "@testing-library/react";
import { CartDrawer } from "@/components/cart/cart-drawer";
import { useCartStore } from "@/lib/cart";
import { act } from "@testing-library/react";

beforeEach(() => {
  act(() => useCartStore.setState({ items: [] }));
});

describe("CartDrawer", () => {
  it("shows empty state when cart is empty", () => {
    render(<CartDrawer open onOpenChange={() => {}} />);
    expect(screen.getByText(/panier vide/i)).toBeInTheDocument();
  });

  it("displays cart items", () => {
    act(() =>
      useCartStore.getState().addItem({
        productId: "p1",
        slug: "iphone",
        name: "iPhone 16",
        price: 1_000_000,
        image: "/placeholder.svg",
      })
    );
    render(<CartDrawer open onOpenChange={() => {}} />);
    expect(screen.getByText("iPhone 16")).toBeInTheDocument();
    expect(screen.getByText(/1 000 000/)).toBeInTheDocument();
  });

  it("removes item on click delete", () => {
    act(() =>
      useCartStore.getState().addItem({
        productId: "p1",
        slug: "iphone",
        name: "iPhone 16",
        price: 1_000_000,
        image: "/placeholder.svg",
      })
    );
    render(<CartDrawer open onOpenChange={() => {}} />);
    fireEvent.click(screen.getByRole("button", { name: /supprimer/i }));
    expect(screen.getByText(/panier vide/i)).toBeInTheDocument();
  });
});
```

**Step 2 : Vérifier que le test échoue**
```bash
bun run test tests/components/cart/cart-drawer.test.tsx
```

**Step 3 : Créer CartItemRow**

```tsx
// components/cart/cart-item-row.tsx
"use client";
import Image from "next/image";
import { Trash2, Plus, Minus } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useCartStore, type CartItem } from "@/lib/cart";

function formatPrice(p: number) {
  return p.toLocaleString("fr-FR");
}

export function CartItemRow({ item }: { item: CartItem }) {
  const { removeItem, setQuantity } = useCartStore();
  return (
    <div className="flex gap-3 py-4">
      <div className="relative size-16 shrink-0 overflow-hidden rounded-md border bg-muted/50">
        <Image src={item.image} alt={item.name} fill className="object-contain p-1" sizes="64px" />
      </div>
      <div className="flex flex-1 flex-col gap-1">
        <p className="text-sm font-medium leading-snug line-clamp-2">{item.name}</p>
        <p className="text-sm font-bold">{formatPrice(item.price)} FCFA</p>
        <div className="flex items-center gap-2">
          <Button
            variant="outline"
            size="icon"
            className="size-6"
            onClick={() => setQuantity(item.productId, item.quantity - 1)}
            aria-label="Diminuer la quantité"
          >
            <Minus className="size-3" />
          </Button>
          <span className="w-5 text-center text-sm">{item.quantity}</span>
          <Button
            variant="outline"
            size="icon"
            className="size-6"
            onClick={() => setQuantity(item.productId, item.quantity + 1)}
            aria-label="Augmenter la quantité"
          >
            <Plus className="size-3" />
          </Button>
          <Button
            variant="ghost"
            size="icon"
            className="ml-auto size-6 text-muted-foreground hover:text-destructive"
            onClick={() => removeItem(item.productId)}
            aria-label="Supprimer"
          >
            <Trash2 className="size-3" />
          </Button>
        </div>
      </div>
    </div>
  );
}
```

**Step 4 : Créer CartDrawer**

```tsx
// components/cart/cart-drawer.tsx
"use client";
import Link from "next/link";
import { ShoppingCart } from "lucide-react";
import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetFooter } from "@/components/ui/sheet";
import { Button } from "@/components/ui/button";
import { Separator } from "@/components/ui/separator";
import { useCartStore } from "@/lib/cart";
import { CartItemRow } from "./cart-item-row";

function formatPrice(p: number) {
  return p.toLocaleString("fr-FR");
}

type Props = { open: boolean; onOpenChange: (open: boolean) => void };

export function CartDrawer({ open, onOpenChange }: Props) {
  const { items, total, count } = useCartStore();
  const itemCount = count();

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent className="flex w-full flex-col sm:max-w-md">
        <SheetHeader>
          <SheetTitle>
            Panier{itemCount > 0 ? ` (${itemCount})` : ""}
          </SheetTitle>
        </SheetHeader>

        {items.length === 0 ? (
          <div className="flex flex-1 flex-col items-center justify-center gap-4 text-center">
            <ShoppingCart className="size-12 text-muted-foreground" />
            <p className="font-medium">Votre panier est vide</p>
            <p className="text-sm text-muted-foreground">
              Ajoutez des produits pour commencer vos achats.
            </p>
            <Button variant="outline" onClick={() => onOpenChange(false)}>
              Continuer les achats
            </Button>
          </div>
        ) : (
          <>
            <div className="flex-1 divide-y overflow-y-auto">
              {items.map((item) => (
                <CartItemRow key={item.productId} item={item} />
              ))}
            </div>
            <SheetFooter className="flex-col gap-3 pt-4">
              <Separator />
              <div className="flex items-center justify-between text-sm">
                <span className="text-muted-foreground">Sous-total</span>
                <span className="font-bold">{formatPrice(total())} FCFA</span>
              </div>
              <p className="text-xs text-muted-foreground">
                Livraison et taxes calculées au moment du paiement.
              </p>
              <Button size="lg" asChild className="w-full">
                <Link href="/checkout" onClick={() => onOpenChange(false)}>
                  Commander
                </Link>
              </Button>
              <Button variant="outline" size="sm" onClick={() => onOpenChange(false)} className="w-full">
                Continuer les achats
              </Button>
            </SheetFooter>
          </>
        )}
      </SheetContent>
    </Sheet>
  );
}
```

**Step 5 : Vérifier que les tests passent**
```bash
bun run test tests/components/cart/
```
Attendu : PASS

**Step 6 : Commit**
```bash
git add components/cart/ tests/components/cart/
git commit -m "feat: add CartDrawer with item management"
```

---

### Task 2.3 : Brancher le CartDrawer dans l'AppBar

**Files:**
- Modify: `components/layout/app-bar/cart-indicator.tsx`
- Modify: `components/layout/app-bar/app-bar.tsx`

**Step 1 : Lire le code existant**
```bash
cat components/layout/app-bar/cart-indicator.tsx
cat components/layout/app-bar/app-bar.tsx
```

**Step 2 : Mettre à jour CartIndicator pour afficher le badge de quantité**

```tsx
// components/layout/app-bar/cart-indicator.tsx
"use client";
import { ShoppingCart } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useCartStore } from "@/lib/cart";

type Props = { onClick: () => void };

export function CartIndicator({ onClick }: Props) {
  const count = useCartStore((s) => s.count());
  return (
    <Button variant="ghost" size="icon" onClick={onClick} aria-label="Panier" className="relative">
      <ShoppingCart className="size-5" />
      {count > 0 ? (
        <span className="absolute -right-0.5 -top-0.5 flex size-4 items-center justify-center rounded-full bg-primary text-[10px] font-bold text-primary-foreground">
          {count > 99 ? "99+" : count}
        </span>
      ) : null}
    </Button>
  );
}
```

**Step 3 : Ajouter l'état du drawer dans AppBar et passer le callback à CartIndicator**

Dans `app-bar.tsx`, ajouter `"use client"`, `useState` pour `cartOpen`, brancher `<CartDrawer>` et passer `onClick` à `CartIndicator`.

**Step 4 : Test manuel**
- Ouvrir `http://localhost:33000`
- Cliquer sur l'icône panier → drawer s'ouvre avec "Panier vide"
- Aller sur une page produit, cliquer "Ajouter au panier"
- Le badge s'incrémente, le drawer affiche le produit

**Step 5 : Mettre à jour le test CartIndicator**
```bash
bun run test tests/components/layout/app-bar/cart-indicator.test.tsx
```

**Step 6 : Brancher le bouton "Ajouter au panier" dans ProductCard et ProductDetailPage**

Dans `components/products/product-card.tsx`, le `onClick` existant appelle `e.preventDefault()` — le remplacer par `useCartStore().addItem(...)`.

Dans `app/(main)/produits/[slug]/page.tsx`, le bouton `<Button ... disabled={isOutOfStock}>` doit devenir un `"use client"` wrapper ou un composant client `AddToCartButton`.

**Créer `components/products/add-to-cart-button.tsx` (client)** :
```tsx
"use client";
import { ShoppingCart } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useCartStore } from "@/lib/cart";
import type { Product } from "@/lib/db/schema";

export function AddToCartButton({ product }: { product: Product }) {
  const addItem = useCartStore((s) => s.addItem);
  const isOutOfStock = product.stock === 0;
  return (
    <Button
      size="lg"
      className="flex-1 gap-2"
      disabled={isOutOfStock}
      onClick={() =>
        addItem({
          productId: product.id,
          slug: product.slug,
          name: product.name,
          price: product.price,
          image: product.images[0] ?? "/images/products/placeholder.svg",
        })
      }
    >
      <ShoppingCart className="size-4" />
      {isOutOfStock ? "Rupture de stock" : "Ajouter au panier"}
    </Button>
  );
}
```

**Step 7 : Commit**
```bash
git add components/layout/app-bar/cart-indicator.tsx components/products/add-to-cart-button.tsx
git commit -m "feat: wire cart indicator badge and add-to-cart buttons"
```

---

### Task 2.4 : Tests & validation Phase 2

**Step 1 : Lancer tous les tests**
```bash
bun run test
```
Attendu : tous PASS

**Step 2 : Build**
```bash
bun run build
```
Attendu : succès sans erreurs TypeScript

**Step 3 : Lint**
```bash
bun run lint
```

**Step 4 : Commit de validation**
```bash
git commit -m "chore: phase 2 cart — all tests pass, build clean"
```

---

## Phase 3 — Tunnel de commande (Checkout)

> **Branche :** `feat/checkout`
> **Durée estimée :** 1.5 jour
> **Objectif :** Pages de commande multi-étapes : récapitulatif → adresse → confirmation. Paiement à la livraison (COD) en premier, CinetPay en second.

### Task 3.1 : Schéma DB — orders & order_items

**Files:**
- Modify: `lib/db/schema.ts`
- Create: `drizzle/<migration>.sql` (généré automatiquement)

**Step 1 : Ajouter les tables au schéma**

```ts
// Ajouter dans lib/db/schema.ts

export type OrderStatus = "pending" | "confirmed" | "shipped" | "delivered" | "cancelled";
export type PaymentMethod = "cod" | "mobile_money" | "card";
export type PaymentStatus = "pending" | "paid" | "failed" | "refunded";

export const orders = sqliteTable("orders", {
  id: text("id").primaryKey(),
  user_id: text("user_id").notNull(),
  status: text("status").$type<OrderStatus>().default("pending").notNull(),
  payment_method: text("payment_method").$type<PaymentMethod>().notNull(),
  payment_status: text("payment_status").$type<PaymentStatus>().default("pending").notNull(),
  // Adresse de livraison (dénormalisée)
  shipping_name: text("shipping_name").notNull(),
  shipping_phone: text("shipping_phone").notNull(),
  shipping_city: text("shipping_city").notNull(),
  shipping_address: text("shipping_address").notNull(),
  shipping_notes: text("shipping_notes"),
  // Totaux
  subtotal: integer("subtotal").notNull(),    // en FCFA
  shipping_fee: integer("shipping_fee").default(0).notNull(),
  total: integer("total").notNull(),
  created_at: integer("created_at", { mode: "timestamp" }).notNull(),
  updated_at: integer("updated_at", { mode: "timestamp" }).notNull(),
});

export const order_items = sqliteTable("order_items", {
  id: text("id").primaryKey(),
  order_id: text("order_id").notNull().references(() => orders.id),
  product_id: text("product_id").notNull(),
  product_name: text("product_name").notNull(),
  product_slug: text("product_slug").notNull(),
  product_image: text("product_image").notNull(),
  unit_price: integer("unit_price").notNull(),
  quantity: integer("quantity").notNull(),
  line_total: integer("line_total").notNull(),
});

export type Order = typeof orders.$inferSelect;
export type NewOrder = typeof orders.$inferInsert;
export type OrderItem = typeof order_items.$inferSelect;
export type NewOrderItem = typeof order_items.$inferInsert;
```

**Step 2 : Générer et appliquer la migration**
```bash
bun run db:generate
bun run db:migrate
```
Attendu : fichier SQL créé dans `drizzle/`, migration appliquée.

**Step 3 : Commit**
```bash
git add lib/db/schema.ts drizzle/
git commit -m "feat: add orders and order_items tables to schema"
```

---

### Task 3.2 : Server action — createOrder

**Files:**
- Create: `lib/actions/orders.ts`
- Create: `tests/lib/actions/orders.test.ts`

**Step 1 : Écrire le test**
```ts
// tests/lib/actions/orders.test.ts
import { describe, it, expect, vi } from "vitest";
// Test unitaire : mock db et auth
vi.mock("@/lib/db", () => ({ getDb: vi.fn() }));
vi.mock("@/lib/auth-client", () => ({ authClient: { useSession: vi.fn() } }));

import { buildOrder } from "@/lib/actions/orders";

describe("buildOrder", () => {
  it("calculates correct totals", () => {
    const items = [
      { productId: "p1", name: "A", slug: "a", price: 100_000, image: "/a.svg", quantity: 2 },
      { productId: "p2", name: "B", slug: "b", price: 50_000, image: "/b.svg", quantity: 1 },
    ];
    const result = buildOrder(items, "cod");
    expect(result.subtotal).toBe(250_000);
    expect(result.shipping_fee).toBe(0); // COD Abidjan gratuit
    expect(result.total).toBe(250_000);
  });
});
```

**Step 2 : Implémenter**

```ts
// lib/actions/orders.ts
"use server";
import { randomUUID } from "crypto";
import { redirect } from "next/navigation";
import { getDb } from "@/lib/db";
import { orders, order_items } from "@/lib/db/schema";
import type { PaymentMethod } from "@/lib/db/schema";
import { auth } from "@/lib/auth";
import { headers } from "next/headers";

type CartItemInput = {
  productId: string;
  name: string;
  slug: string;
  price: number;
  image: string;
  quantity: number;
};

export function buildOrder(items: CartItemInput[], paymentMethod: PaymentMethod) {
  const subtotal = items.reduce((sum, i) => sum + i.price * i.quantity, 0);
  const shipping_fee = 0; // Livraison gratuite phase initiale
  return { subtotal, shipping_fee, total: subtotal + shipping_fee, paymentMethod };
}

export type CheckoutFormData = {
  name: string;
  phone: string;
  city: string;
  address: string;
  notes?: string;
  payment_method: PaymentMethod;
  items: CartItemInput[];
};

export async function createOrder(data: CheckoutFormData): Promise<{ orderId: string }> {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session?.user) redirect("/connexion");

  const { subtotal, shipping_fee, total } = buildOrder(data.items, data.payment_method);
  const orderId = randomUUID();
  const now = new Date();

  const db = getDb();
  await db.insert(orders).values({
    id: orderId,
    user_id: session.user.id,
    status: "pending",
    payment_method: data.payment_method,
    payment_status: "pending",
    shipping_name: data.name,
    shipping_phone: data.phone,
    shipping_city: data.city,
    shipping_address: data.address,
    shipping_notes: data.notes ?? null,
    subtotal,
    shipping_fee,
    total,
    created_at: now,
    updated_at: now,
  });

  await db.insert(order_items).values(
    data.items.map((item) => ({
      id: randomUUID(),
      order_id: orderId,
      product_id: item.productId,
      product_name: item.name,
      product_slug: item.slug,
      product_image: item.image,
      unit_price: item.price,
      quantity: item.quantity,
      line_total: item.price * item.quantity,
    }))
  );

  return { orderId };
}
```

**Step 3 : Tests**
```bash
bun run test tests/lib/actions/orders.test.ts
```

**Step 4 : Commit**
```bash
git add lib/actions/orders.ts tests/lib/actions/orders.test.ts
git commit -m "feat: add createOrder server action"
```

---

### Task 3.3 : Page Checkout

**Files:**
- Create: `app/(main)/checkout/page.tsx`
- Create: `app/(main)/checkout/checkout-form.tsx` (client)
- Create: `app/(main)/commande/[id]/page.tsx` (confirmation)

**Step 1 : Page de confirmation (simple, server)**

```tsx
// app/(main)/commande/[id]/page.tsx
import { notFound } from "next/navigation";
import Link from "next/link";
import { CheckCircle } from "lucide-react";
import { getDb } from "@/lib/db";
import { orders, order_items } from "@/lib/db/schema";
import { eq } from "drizzle-orm";
import { Button } from "@/components/ui/button";
import { auth } from "@/lib/auth";
import { headers } from "next/headers";

type Props = { params: Promise<{ id: string }> };

export default async function OrderConfirmationPage({ params }: Props) {
  const { id } = await params;
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session?.user) notFound();

  const db = getDb();
  const [order] = await db.select().from(orders).where(eq(orders.id, id)).limit(1);
  if (!order || order.user_id !== session.user.id) notFound();

  const items = await db.select().from(order_items).where(eq(order_items.order_id, id));

  return (
    <div className="mx-auto max-w-2xl px-4 py-16 text-center">
      <CheckCircle className="mx-auto size-16 text-green-500" />
      <h1 className="mt-6 text-2xl font-bold">Commande confirmée !</h1>
      <p className="mt-2 text-muted-foreground">
        Merci pour votre commande. Nous vous contacterons au{" "}
        <strong>{order.shipping_phone}</strong> pour organiser la livraison.
      </p>
      <div className="mt-8 rounded-xl border bg-card p-6 text-left">
        <h2 className="font-semibold">Récapitulatif — Commande #{id.slice(0, 8).toUpperCase()}</h2>
        <ul className="mt-4 space-y-2">
          {items.map((item) => (
            <li key={item.id} className="flex justify-between text-sm">
              <span>{item.product_name} × {item.quantity}</span>
              <span>{item.line_total.toLocaleString("fr-FR")} FCFA</span>
            </li>
          ))}
        </ul>
        <div className="mt-4 border-t pt-4 flex justify-between font-bold">
          <span>Total</span>
          <span>{order.total.toLocaleString("fr-FR")} FCFA</span>
        </div>
      </div>
      <div className="mt-8 flex flex-col gap-3 sm:flex-row sm:justify-center">
        <Button asChild>
          <Link href="/compte/commandes">Voir mes commandes</Link>
        </Button>
        <Button variant="outline" asChild>
          <Link href="/">Continuer les achats</Link>
        </Button>
      </div>
    </div>
  );
}
```

**Step 2 : CheckoutForm (client)**

```tsx
// app/(main)/checkout/checkout-form.tsx
"use client";
import { useState } from "react";
import { useRouter } from "next/navigation";
import { useCartStore } from "@/lib/cart";
import { createOrder } from "@/lib/actions/orders";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Separator } from "@/components/ui/separator";

function formatPrice(p: number) { return p.toLocaleString("fr-FR"); }

export function CheckoutForm() {
  const router = useRouter();
  const { items, total, count, clear } = useCartStore();
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  if (count() === 0) {
    router.replace("/");
    return null;
  }

  async function onSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault();
    setLoading(true);
    setError(null);
    const fd = new FormData(e.currentTarget);
    try {
      const { orderId } = await createOrder({
        name: fd.get("name") as string,
        phone: fd.get("phone") as string,
        city: fd.get("city") as string,
        address: fd.get("address") as string,
        notes: fd.get("notes") as string,
        payment_method: "cod",
        items: items.map((i) => ({
          productId: i.productId,
          name: i.name,
          slug: i.slug,
          price: i.price,
          image: i.image,
          quantity: i.quantity,
        })),
      });
      clear();
      router.push(`/commande/${orderId}`);
    } catch {
      setError("Une erreur est survenue. Veuillez réessayer.");
      setLoading(false);
    }
  }

  return (
    <div className="mx-auto grid max-w-4xl gap-8 px-4 py-12 lg:grid-cols-[1fr_360px] lg:px-6">
      <form onSubmit={onSubmit} className="space-y-6">
        <h1 className="text-2xl font-bold">Finaliser la commande</h1>
        <fieldset className="space-y-4">
          <legend className="text-base font-semibold">Informations de livraison</legend>
          <div className="grid gap-4 sm:grid-cols-2">
            <div className="space-y-1.5">
              <Label htmlFor="name">Nom complet</Label>
              <Input id="name" name="name" required placeholder="Jean Kouassi" />
            </div>
            <div className="space-y-1.5">
              <Label htmlFor="phone">Téléphone</Label>
              <Input id="phone" name="phone" required placeholder="+225 07 XX XX XX XX" />
            </div>
          </div>
          <div className="space-y-1.5">
            <Label htmlFor="city">Ville</Label>
            <Input id="city" name="city" required placeholder="Abidjan, Cocody" />
          </div>
          <div className="space-y-1.5">
            <Label htmlFor="address">Adresse complète</Label>
            <Input id="address" name="address" required placeholder="Rue des Jardins, Résidence Les Palmiers" />
          </div>
          <div className="space-y-1.5">
            <Label htmlFor="notes">Notes (optionnel)</Label>
            <Textarea id="notes" name="notes" placeholder="Indications supplémentaires..." />
          </div>
        </fieldset>
        <fieldset>
          <legend className="mb-3 text-base font-semibold">Mode de paiement</legend>
          <label className="flex items-center gap-3 rounded-lg border p-4 cursor-pointer has-[:checked]:border-primary">
            <input type="radio" name="payment" value="cod" defaultChecked className="accent-primary" />
            <div>
              <p className="font-medium">Paiement à la livraison</p>
              <p className="text-sm text-muted-foreground">Payez en espèces à la réception</p>
            </div>
          </label>
        </fieldset>
        {error ? <p className="text-sm text-destructive">{error}</p> : null}
        <Button type="submit" size="lg" className="w-full" disabled={loading}>
          {loading ? "Traitement..." : "Confirmer la commande"}
        </Button>
      </form>

      {/* Order summary */}
      <div className="space-y-4">
        <h2 className="font-semibold">Votre commande</h2>
        <ul className="divide-y rounded-xl border">
          {items.map((item) => (
            <li key={item.productId} className="flex items-center gap-3 p-3 text-sm">
              <span className="flex-1 line-clamp-1">{item.name}</span>
              <span className="text-muted-foreground">×{item.quantity}</span>
              <span className="font-medium">{formatPrice(item.price * item.quantity)}</span>
            </li>
          ))}
        </ul>
        <Separator />
        <div className="flex justify-between font-bold">
          <span>Total</span>
          <span>{formatPrice(total())} FCFA</span>
        </div>
        <p className="text-xs text-muted-foreground">Livraison gratuite en Côte d&apos;Ivoire.</p>
      </div>
    </div>
  );
}
```

**Step 3 : Page checkout (server — vérifie session)**

```tsx
// app/(main)/checkout/page.tsx
import { redirect } from "next/navigation";
import { auth } from "@/lib/auth";
import { headers } from "next/headers";
import { CheckoutForm } from "./checkout-form";

export default async function CheckoutPage() {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session?.user) redirect("/connexion?callbackUrl=/checkout");
  if (!session.user.emailVerified) redirect("/email-non-verifie");
  return <CheckoutForm />;
}
```

**Step 4 : Test manuel**
- Ajouter un produit au panier
- Cliquer "Commander" dans le drawer → page `/checkout`
- Remplir le formulaire → confirmation → page `/commande/{id}`

**Step 5 : Lint & tests**
```bash
bun run lint && bun run test
```

**Step 6 : Commit**
```bash
git add app/(main)/checkout/ app/(main)/commande/
git commit -m "feat: checkout flow — form, createOrder action, confirmation page"
```

---

## Phase 4 — Espace Compte (/compte)

> **Branche :** `feat/compte`
> **Durée estimée :** 1 jour
> **Objectif :** Permettre à l'utilisateur connecté de voir ses commandes et gérer son profil.

### Task 4.1 : Layout /compte

**Files:**
- Create: `app/(compte)/layout.tsx`
- Create: `app/(compte)/commandes/page.tsx`
- Create: `app/(compte)/commandes/[id]/page.tsx`
- Create: `app/(compte)/profil/page.tsx`

**Step 1 : Créer le layout avec navigation latérale**

```tsx
// app/(compte)/layout.tsx
import { redirect } from "next/navigation";
import Link from "next/link";
import { auth } from "@/lib/auth";
import { headers } from "next/headers";

const nav = [
  { label: "Mes commandes", href: "/compte/commandes" },
  { label: "Mon profil", href: "/compte/profil" },
];

export default async function CompteLayout({ children }: { children: React.ReactNode }) {
  const session = await auth.api.getSession({ headers: await headers() });
  if (!session?.user) redirect("/connexion?callbackUrl=/compte/commandes");

  return (
    <div className="mx-auto max-w-5xl px-4 py-8 lg:px-6">
      <h1 className="text-xl font-bold">Mon compte</h1>
      <p className="mt-1 text-sm text-muted-foreground">{session.user.email}</p>
      <div className="mt-8 flex flex-col gap-8 lg:flex-row">
        <nav className="flex gap-2 lg:w-48 lg:flex-col">
          {nav.map((item) => (
            <Link
              key={item.href}
              href={item.href}
              className="rounded-md px-3 py-2 text-sm font-medium transition-colors hover:bg-muted"
            >
              {item.label}
            </Link>
          ))}
        </nav>
        <main className="flex-1">{children}</main>
      </div>
    </div>
  );
}
```

**Step 2 : Page liste des commandes**

Requête DB : `SELECT * FROM orders WHERE user_id = session.user.id ORDER BY created_at DESC`

Afficher : numéro de commande (8 premiers chars), date, total, statut (badge coloré), lien vers le détail.

**Step 3 : Page détail commande**

Réutiliser la logique de `app/(main)/commande/[id]/page.tsx` mais dans le contexte /compte.

**Step 4 : Page profil**

Afficher nom, email. Bouton "Se déconnecter" via `authClient.signOut()`.

**Step 5 : Tests**
```bash
bun run test && bun run build
```

**Step 6 : Commit**
```bash
git add app/\(compte\)/
git commit -m "feat: user account area — orders list, order detail, profile"
```

---

## Phase 5 — Recherche fonctionnelle

> **Branche :** `feat/search`
> **Durée estimée :** 0.5 jour
> **Objectif :** Brancher l'overlay de recherche existant sur une vraie requête DB (LIKE sur name et brand).

### Task 5.1 : Route API de recherche

**Files:**
- Create: `app/api/search/route.ts`

```ts
// app/api/search/route.ts
import { NextRequest, NextResponse } from "next/server";
import { like, or, and, eq } from "drizzle-orm";
import { getDb } from "@/lib/db";
import { products } from "@/lib/db/schema";

export async function GET(req: NextRequest) {
  const q = req.nextUrl.searchParams.get("q")?.trim();
  if (!q || q.length < 2) return NextResponse.json([]);

  const db = getDb();
  const pattern = `%${q}%`;
  const rows = await db
    .select({ id: products.id, name: products.name, slug: products.slug, price: products.price, brand: products.brand, image: products.images })
    .from(products)
    .where(and(or(like(products.name, pattern), like(products.brand, pattern)), eq(products.is_active, true)))
    .limit(8);

  return NextResponse.json(
    rows.map((r) => {
      let image = "/images/products/placeholder.svg";
      try { image = JSON.parse(r.image)[0] ?? image; } catch { /* noop */ }
      return { ...r, image };
    })
  );
}
```

### Task 5.2 : Brancher SearchOverlay

**Files:**
- Modify: `components/layout/app-bar/search-overlay.tsx`

Lire le composant existant, puis ajouter un `useEffect` sur la query avec debounce 300ms qui appelle `/api/search?q=...` et affiche les résultats sous le champ de recherche.

**Step 1 : Test API**
```bash
curl "http://localhost:33000/api/search?q=iphone"
```
Attendu : JSON avec les iPhones du seed.

**Step 2 : Commit**
```bash
git add app/api/search/ components/layout/app-bar/search-overlay.tsx
git commit -m "feat: functional search — API route + wired overlay"
```

---

## Phase 6 — Pages manquantes

> **Branche :** `feat/pages-statiques`
> **Durée estimée :** 0.5 jour

### Task 6.1 : Page /offres

**Files:**
- Create: `app/(main)/offres/page.tsx`

Réutiliser la structure de la page catégorie. Requête : `WHERE old_price IS NOT NULL AND is_active = 1`.

### Task 6.2 : Page /support

**Files:**
- Create: `app/(main)/support/page.tsx`

FAQ statique en accordéon (utiliser `<details>/<summary>` ou Radix Accordion), formulaire de contact (UI only — email via Resend dans une prochaine itération).

### Task 6.3 : Corriger les accents sur la page d'accueil

**Files:**
- Modify: `app/(main)/page.tsx`

Corriger : `Découvrez`, `Côte d'Ivoire`, `Économisez`, `préférés`, `dernières nouveautés`, `catégorie`.

**Step : Commit**
```bash
git add app/\(main\)/offres/ app/\(main\)/support/ app/\(main\)/page.tsx
git commit -m "feat: offres page, support page, fix typos/accents on homepage"
```

---

## Phase 7 — Back-office Admin

> **Branche :** `feat/admin`
> **Durée estimée :** 2 jours
> **Prérequis :** Middleware déjà en place (vérification org `dbs-store`).

### Task 7.1 : Layout admin

**Files:**
- Create: `app/(admin)/layout.tsx`
- Create: `app/(admin)/page.tsx` (dashboard)

Navigation : Tableau de bord, Produits, Commandes.

### Task 7.2 : Gestion produits (CRUD)

**Files:**
- Create: `app/(admin)/produits/page.tsx` — liste paginée
- Create: `app/(admin)/produits/nouveau/page.tsx` — formulaire création
- Create: `app/(admin)/produits/[id]/page.tsx` — formulaire édition
- Create: `lib/actions/admin/products.ts` — server actions

**Server actions :** `createProduct`, `updateProduct`, `toggleProductActive`.

**Formulaire produit :** nom, slug (auto-généré depuis nom), catégorie (select), prix, prix barré, marque, stock, badge, description, specs (key-value dynamique), images (URL saisies manuellement pour l'instant).

### Task 7.3 : Gestion commandes

**Files:**
- Create: `app/(admin)/commandes/page.tsx` — liste avec filtres statut
- Create: `app/(admin)/commandes/[id]/page.tsx` — détail + changement de statut
- Create: `lib/actions/admin/orders.ts` — `updateOrderStatus`

**Step : Tests & commit par sous-tâche**
```bash
# Après chaque sous-tâche :
bun run test && bun run lint
git commit -m "feat(admin): ..."
```

---

## Phase 8 — SEO & Production

> **Branche :** `feat/seo`
> **Durée estimée :** 0.5 jour

### Task 8.1 : Métadonnées de base

**Files:**
- Modify: `app/layout.tsx` — ajouter `metadataBase`, Open Graph default
- Modify: `app/(main)/page.tsx` — exporter `metadata`

```ts
// app/layout.tsx — dans le export metadata
export const metadata = {
  metadataBase: new URL(process.env.NEXT_PUBLIC_BASE_URL ?? "http://localhost:33000"),
  title: { default: "DBS Store — La tech au meilleur prix", template: "%s — DBS Store" },
  description: "Smartphones, tablettes, ordinateurs et accessoires. Livraison rapide en Côte d'Ivoire et zone UEMOA.",
  openGraph: { siteName: "DBS Store", locale: "fr_CI", type: "website" },
};
```

### Task 8.2 : Sitemap & robots

**Files:**
- Create: `app/sitemap.ts`
- Create: `app/robots.ts`

```ts
// app/sitemap.ts
import { MetadataRoute } from "next";
import { categories } from "@/lib/data/categories";
import { getDb } from "@/lib/db";
import { products } from "@/lib/db/schema";
import { eq } from "drizzle-orm";

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const base = process.env.NEXT_PUBLIC_BASE_URL ?? "http://localhost:33000";
  const db = getDb();
  const prods = await db.select({ slug: products.slug }).from(products).where(eq(products.is_active, true));

  return [
    { url: base, lastModified: new Date(), priority: 1 },
    ...categories.map((c) => ({ url: `${base}/${c.slug}`, priority: 0.8 })),
    ...prods.map((p) => ({ url: `${base}/produits/${p.slug}`, priority: 0.6 })),
  ];
}
```

**Step : Commit**
```bash
git add app/sitemap.ts app/robots.ts app/layout.tsx
git commit -m "feat: SEO — metadata, sitemap, robots"
```

---

## Récapitulatif des phases

| Phase | Branche | Priorité | Statut |
|-------|---------|----------|--------|
| 1 — Seed data | `feat/seed-data` | Haute | A faire |
| 2 — Panier | `feat/cart` | Haute | A faire |
| 3 — Checkout | `feat/checkout` | Haute | A faire |
| 4 — Espace compte | `feat/compte` | Haute | A faire |
| 5 — Recherche | `feat/search` | Moyenne | A faire |
| 6 — Pages manquantes | `feat/pages-statiques` | Moyenne | A faire |
| 7 — Admin | `feat/admin` | Moyenne | A faire |
| 8 — SEO | `feat/seo` | Faible | A faire |

## Checklist de validation par phase

Avant de merger chaque branche vers `main` :

- [ ] `bun run test` — tous les tests passent (aucun FAIL, aucun SKIP non intentionnel)
- [ ] `bun run build` — build Next.js sans erreur TypeScript
- [ ] `bun run lint` — ESLint sans erreurs
- [ ] Test manuel sur `http://localhost:33000` — le flux visé fonctionne de bout en bout
- [ ] Pas de `console.error` dans le terminal de dev pendant le test manuel
- [ ] Squash merge vers `main` avec message de commit descriptif
